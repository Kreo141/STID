
//                                                                                                             
//                                                                                                             
//  `7MMM.     ,MMF' .M"""bgd      db      `7MMF'                db   `7MMF'   `7MF'MMP""MM""YMM `7MMF'  `7MMF'
//    MMMb    dPMM  ,MI    "Y     ;MM:       MM                 ;MM:    MM       M  P'   MM   `7   MM      MM  
//    M YM   ,M MM  `MMb.        ,V^MM.      MM                ,V^MM.   MM       M       MM        MM      MM  
//    M  Mb  M' MM    `YMMNq.   ,M  `MM      MM               ,M  `MM   MM       M       MM        MMmmmmmmMM  
//    M  YM.P'  MM  .     `MM   AbmmmqMA     MM      ,        AbmmmqMA  MM       M       MM        MM      MM  
//    M  `YM'   MM  Mb     dM  A'     VML    MM     ,M       A'     VML YM.     ,M       MM        MM      MM  
//  .JML. `'  .JMML.P"Ybmmd" .AMA.   .AMMA..JMMmmmmMMM     .AMA.   .AMMA.`bmmmmd"'     .JMML.    .JMML.  .JMML.
//                                                                                                             
//                                                                                                             

//
//   $$$$$$\                                                             $$\                     $$\       $$\                 
//  $$  __$$\                                                            $$ |                    $$ |      $$ |                
//  $$ /  \__| $$$$$$\  $$$$$$\$$$$\  $$$$$$\$$$$\   $$$$$$\  $$$$$$$\ $$$$$$\    $$$$$$\   $$$$$$$ |      $$$$$$$\  $$\   $$\ 
//  $$ |      $$  __$$\ $$  _$$  _$$\ $$  _$$  _$$\ $$  __$$\ $$  __$$\\_$$  _|  $$  __$$\ $$  __$$ |      $$  __$$\ $$ |  $$ |
//  $$ |      $$ /  $$ |$$ / $$ / $$ |$$ / $$ / $$ |$$$$$$$$ |$$ |  $$ | $$ |    $$$$$$$$ |$$ /  $$ |      $$ |  $$ |$$ |  $$ |
//  $$ |  $$\ $$ |  $$ |$$ | $$ | $$ |$$ | $$ | $$ |$$   ____|$$ |  $$ | $$ |$$\ $$   ____|$$ |  $$ |      $$ |  $$ |$$ |  $$ |
//  \$$$$$$  |\$$$$$$  |$$ | $$ | $$ |$$ | $$ | $$ |\$$$$$$$\ $$ |  $$ | \$$$$  |\$$$$$$$\ \$$$$$$$ |      $$$$$$$  |\$$$$$$$ |
//   \______/  \______/ \__| \__| \__|\__| \__| \__| \_______|\__|  \__|  \____/  \_______| \_______|      \_______/  \____$$ |
//                                                                                                                         $$ |
//                                                                                                                         $$ |
//            _____                    _____                    _____                _____                            _____                    _____                    _____            _____                    _____                    _____                   _______         
//           /\    \                  /\    \                  /\    \              |\    \                          /\    \                  /\    \                  /\    \          /\    \                  /\    \                  /\    \                 /::\    \        
//          /::\    \                /::\    \                /::\    \             |:\____\                        /::\    \                /::\    \                /::\____\        /::\    \                /::\    \                /::\    \               /::::\    \       
//         /::::\    \               \:::\    \              /::::\    \            |::|   |                       /::::\    \              /::::\    \              /:::/    /       /::::\    \              /::::\    \              /::::\    \             /::::::\    \      
//        /::::::\    \               \:::\    \            /::::::\    \           |::|   |                      /::::::\    \            /::::::\    \            /:::/    /       /::::::\    \            /::::::\    \            /::::::\    \           /::::::::\    \     
//       /:::/\:::\    \               \:::\    \          /:::/\:::\    \          |::|   |                     /:::/\:::\    \          /:::/\:::\    \          /:::/    /       /:::/\:::\    \          /:::/\:::\    \          /:::/\:::\    \         /:::/~~\:::\    \    
//      /:::/  \:::\    \               \:::\    \        /:::/__\:::\    \         |::|   |                    /:::/__\:::\    \        /:::/__\:::\    \        /:::/    /       /:::/  \:::\    \        /:::/__\:::\    \        /:::/  \:::\    \       /:::/    \:::\    \   
//     /:::/    \:::\    \              /::::\    \      /::::\   \:::\    \        |::|   |                    \:::\   \:::\    \      /::::\   \:::\    \      /:::/    /       /:::/    \:::\    \      /::::\   \:::\    \      /:::/    \:::\    \     /:::/    / \:::\    \  
//    /:::/    / \:::\    \    _____   /::::::\    \    /::::::\   \:::\    \       |::|___|______            ___\:::\   \:::\    \    /::::::\   \:::\    \    /:::/    /       /:::/    / \:::\    \    /::::::\   \:::\    \    /:::/    / \:::\    \   /:::/____/   \:::\____\ 
//   /:::/    /   \:::\    \  /\    \ /:::/\:::\    \  /:::/\:::\   \:::\    \      /::::::::\    \          /\   \:::\   \:::\    \  /:::/\:::\   \:::\    \  /:::/    /       /:::/    /   \:::\ ___\  /:::/\:::\   \:::\    \  /:::/    /   \:::\ ___\ |:::|    |     |:::|    |
//  /:::/____/     \:::\____\/::\    /:::/  \:::\____\/:::/  \:::\   \:::\____\    /::::::::::\____\        /::\   \:::\   \:::\____\/:::/  \:::\   \:::\____\/:::/____/       /:::/____/  ___\:::|    |/:::/  \:::\   \:::\____\/:::/____/     \:::|    ||:::|____|     |:::|    |
//  \:::\    \      \::/    /\:::\  /:::/    \::/    /\::/    \:::\  /:::/    /   /:::/~~~~/~~              \:::\   \:::\   \::/    /\::/    \:::\  /:::/    /\:::\    \       \:::\    \ /\  /:::|____|\::/    \:::\  /:::/    /\:::\    \     /:::|____| \:::\    \   /:::/    / 
//   \:::\    \      \/____/  \:::\/:::/    / \/____/  \/____/ \:::\/:::/    /   /:::/    /                  \:::\   \:::\   \/____/  \/____/ \:::\/:::/    /  \:::\    \       \:::\    /::\ \::/    /  \/____/ \:::\/:::/    /  \:::\    \   /:::/    /   \:::\    \ /:::/    /  
//    \:::\    \               \::::::/    /                    \::::::/    /   /:::/    /                    \:::\   \:::\    \               \::::::/    /    \:::\    \       \:::\   \:::\ \/____/            \::::::/    /    \:::\    \ /:::/    /     \:::\    /:::/    /   
//     \:::\    \               \::::/    /                      \::::/    /   /:::/    /                      \:::\   \:::\____\               \::::/    /      \:::\    \       \:::\   \:::\____\               \::::/    /      \:::\    /:::/    /       \:::\__/:::/    /    
//      \:::\    \               \::/    /                       /:::/    /    \::/    /                        \:::\  /:::/    /               /:::/    /        \:::\    \       \:::\  /:::/    /               /:::/    /        \:::\  /:::/    /         \::::::::/    /     
//       \:::\    \               \/____/                       /:::/    /      \/____/                          \:::\/:::/    /               /:::/    /          \:::\    \       \:::\/:::/    /               /:::/    /          \:::\/:::/    /           \::::::/    /      
//        \:::\    \                                           /:::/    /                                         \::::::/    /               /:::/    /            \:::\    \       \::::::/    /               /:::/    /            \::::::/    /             \::::/    /       
//         \:::\____\                                         /:::/    /                                           \::::/    /               /:::/    /              \:::\____\       \::::/    /               /:::/    /              \::::/    /               \::/____/        
//          \::/    /                                         \::/    /                                             \::/    /                \::/    /                \::/    /        \::/____/                \::/    /                \::/____/                 ~~              
//           \/____/                                           \/____/                                               \/____/                  \/____/                  \/____/                                   \/____/                  ~~                                       
//                                                                                                                                                                                                                                                                                 


// =====================
// DEBUG MODE SWITCH
// =====================
let DEBUG_MODE = false;

// Placeholder for credentials used in debug mode
const DEBUG_CREDENTIALS = {};

// =====================
// MSAL CONFIGURATION
// =====================
const msalConfig = {
    auth: {
        clientId: "", // Azure AD Application Client ID
        authority: "https://login.microsoftonline.com/common", // Generic authority endpoint
        redirectUri: "https://stid.ct.ws/pages/02-Dashboard/dashboard.html", // Redirect after login
        postLogoutRedirectUri: "http://localhost:3000/FNL_Group3/index.html" // Redirect after logout
    },
    cache: {
        cacheLocation: "sessionStorage", // Store auth state in sessionStorage
        storeAuthStateInCookie: true // Enables cookie fallback support for IE11/Edge
    }
};

// Initialize MSAL instance
const msalInstance = new msal.PublicClientApplication(msalConfig);

// Define required scopes
const loginRequest = {
    scopes: ["user.read"]
};

// ==============================
// 1. Handle Redirect Authentication
// ==============================
msalInstance.handleRedirectPromise()
    .then(response => {
        const account = response?.account || msalInstance.getAllAccounts()[0];

        if (account) {
            msalInstance.setActiveAccount(account);

            if (validateEmail(account.username)) {
                // Valid STI email - continue setup
                console.log("Account:", account);
                storeUserSession(account);
                checkIfStudentRegistered(account);
                loadQRCode(account);
                updateProfileInfo(account);

                // Redirect to dashboard if not already there
                const basePath = window.location.pathname.includes("/FNL_Group3") ? "/FNL_Group3" : "";
                if (!window.location.pathname.includes(`${basePath}/pages/02-Dashboard/dashboard.html`)) {
                    redirectToDashboard();
                }
            } else {
                // Invalid email domain - show error popup
                var ifStudentPopup = $(".ifStudentPopup");
                setTimeout(() => {
                    ifStudentPopup.removeClass("hide").addClass("show");
                    setTimeout(() => {
                        ifStudentPopup.removeClass("show").addClass("hide");
                    }, 4000);
                }, 1000);
            }

            // Attempt to silently acquire access token
            msalInstance.acquireTokenSilent(loginRequest)
                .then(tokenResponse => {
                    console.log("Token acquired silently:", tokenResponse);
                })
                .catch(error => {
                    if (error instanceof msal.InteractionRequiredAuthError) {
                        msalInstance.acquireTokenRedirect(loginRequest);
                    } else {
                        console.error("Token acquisition error:", error);
                    }
                });
        }
    })
    .catch(error => {
        console.error("Redirect error", error);
    });

// ==============================
// 2. Silent Token Acquisition (Fallback)
// ==============================
msalInstance.acquireTokenSilent(loginRequest)
    .then(response => {
        // Token acquired silently
    })
    .catch(error => {
        if (error instanceof msal.InteractionRequiredAuthError) {
            // Interactive login required
            msalInstance.acquireTokenRedirect(loginRequest);
        } else {
            console.error("Token acquisition error:", error);
        }
    });

// ==============================
// 3. Store User Session in Backend
// ==============================
function storeUserSession(account) {
    if (!account) return;
    
    // Log login activity to backend
    fetch("api/log_login.php", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username: account.username })
    })
    .then(res => res.json())
    .then(data => console.log(data.message))
    .catch(err => console.error("Log error:", err));

    // Store session data securely
    fetch("/api/store-session", {
        method: "POST",
        credentials: "include",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username: account.username })
    })
    .then(response => {
        if (response.ok) {
            console.log("User session stored securely");
            if (!window.location.pathname.includes("/pages/02-Dashboard/dashboard.html")) {
                redirectToDashboard();
            }
        } else {
            console.error("Failed to store user session");
        }
    })
    .catch(error => console.error("Session storage error:", error));
}

// ==============================
// 4. Student Registration Check & Register
// ==============================
function registerStudent(account){
    const studentID = account.username.split(".")[1].split('@')[0];
    const studentEmail = account.username;
    const studentName = account.name;

    fetch('../../api/register_student.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({
            qr_text: studentEmail + "_" + studentName,
            filename: studentID,
            student_id: studentID,
            student_email: studentEmail
        })
    })
    .then(response => {
        if (response.redirected) {
            window.location.href = response.url;
        } else {
            return response.text();
        }
    })
    .catch(error => console.error('Error:', error));
}

function checkIfStudentRegistered(account){
    const studentID = account.username;

    return fetch(`../../api/fetch_student.php?studentID=${studentID}`)
        .then(response => response.json())
        .then(data => {
            if (data.student_exists) {
                console.log("Student is registered");
            } else {
                console.log("Student is not registered - Registering...");
                registerStudent(account);
            }
            return data;
        })
        .catch(error => console.log("Error fetching student data", error));
}

// ==============================
// 5. Login and Logout Handlers
// ==============================
function signIn() {
    if (DEBUG_MODE) {
        // Use debug credentials for testing
        storeUserSession(DEBUG_CREDENTIALS);
        redirectToDashboard();
        return;
    } else {
        msalInstance.loginRedirect(loginRequest)
        .then(response => {
            const account = msalInstance.getAllAccounts()[0];
            if (account && validateEmail(account.username)) {
                storeUserSession(account);
                redirectToDashboard();
            } else {
                console.error("Invalid email domain");
                signOut();
            }
        })
        .catch(error => {
            console.error("Login error:", error);
        });
    }
}

function signOut() {
    sessionStorage.clear(); // Clear session
    msalInstance.logoutRedirect({
        postLogoutRedirectUri: msalConfig.auth.postLogoutRedirectUri
    });
}

// ==============================
// 6. Email Validation
// ==============================
function validateEmail(email) {
    return email.endsWith("@davao.sti.edu.ph");
}

// ==============================
// 7. Navigation to Dashboard
// ==============================
function redirectToDashboard() {
    const basePath = window.location.pathname.includes("/FNL_Group3") ? "/FNL_Group3" : "";
    window.location.href = `${basePath}/pages/02-Dashboard/dashboard.html`;
}

// ==============================
// 8. Load and Display QR Code
// ==============================
async function getStudentQRCode(account) {
    try {
        if (!account) throw new Error("No account found.");
        let studentQRCodeSrc = await checkIfStudentRegistered(account);
        return studentQRCodeSrc;
    } catch (error) {
        console.error("Error:", error);
        return null;
    }
}

async function loadQRCode(account) {
    const studentQRCodeSrc = await getStudentQRCode(account);
    const qrCodeDisplay = document.getElementById("qr-code-display");

    if (qrCodeDisplay && studentQRCodeSrc?.student_qr_src) {
        qrCodeDisplay.src = studentQRCodeSrc.student_qr_src;

        // Attach download handler
        document.getElementById('downloadQrBtn').addEventListener('click', function () {
            const qrImg = document.getElementById('qr-code-display');
            const qrUrl = qrImg.src;
            if (!qrUrl || qrUrl === '#') {
                alert("QR code not loaded yet.");
                return;
            }

            const link = document.createElement('a');
            link.href = qrUrl;
            link.download = `${account.username.split('@')[0]}qr-code.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
    }
}

// ==============================
// 9. Profile UI Population
// ==============================
function updateProfileInfo(account) {
    if (!account?.name) return;

    try {
        const nameParts = account.name.split(',');
        let firstName, lastName;

        if (nameParts.length > 1) {
            firstName = nameParts[1].trim().split(' ')[0];
            lastName = nameParts[0].trim();
        } else {
            firstName = account.name.split(' ')[0];
            lastName = "";
        }

        const initial = firstName[0]?.toUpperCase() || "";
        const profileElements = [
            document.getElementById('profile'),
            document.getElementById('sidebar_profile')
        ];

        profileElements.forEach(element => {
            if (element) element.textContent = initial;
        });

        const profileNameElement = document.getElementById('profileName');
        if (profileNameElement) {
            profileNameElement.textContent = `${firstName} ${lastName}`.trim();
        }

        const profileEmailElement = document.getElementById('profileEmail');
        if (profileEmailElement && account.username) {
            profileEmailElement.textContent = account.username;
        }
    } catch (error) {
        console.error("Error processing profile information:", error);
    }
}

// ==============================
// 10. Onload Authentication Redirect Handling
// ==============================
window.onload = async function() {
    const account = DEBUG_MODE ? DEBUG_CREDENTIALS : msalInstance.getAllAccounts()[0];

    const isOnDashboard = window.location.pathname.includes("/pages/02-Dashboard/dashboard.html");
    const isOnStudentInfo = window.location.pathname.includes("/pages/04-studentInfo/studentInfo.html");
    const basePath = window.location.pathname.includes("/FNL_Group3") ? "/FNL_Group3" : "";

    if (account) {
        // Redirect to dashboard if not already on allowed page
        if (!isOnDashboard && !isOnStudentInfo) {
            window.location.href = `${basePath}/pages/02-Dashboard/dashboard.html`;
            return;
        }
    } else {
        // If not logged in, and on a protected page, redirect to login
        if (isOnDashboard || isOnStudentInfo) {
            window.location.href = `${basePath}/index.html`;
            return;
        }
    }
};
